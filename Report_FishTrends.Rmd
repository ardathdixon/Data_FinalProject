---
title: "What's the Catch? Recreational Fishing Trends in North Carolina (1990-2019)"
author: "Ardath Dixon, Annie Harshbarger, Eva May"
date: "Spring 2021"
output:
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
  word_document: default
geometry: margin=2.54cm
subtitle: https://github.com/ardathdixon/Data_FinalProject
fontsize: 12pt
mainfont: Times New Roman
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()

# Load your packages
knitr::opts_chunk$set(echo = TRUE, fig.align = 'right', message = FALSE, fig.pos = "H")

library(lubridate)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo)
library(trend)
library(tidyr)
library(forecast)
library(astsa)
library(cowplot)
library(knitr)
library(kableExtra)

# Set your ggplot theme
ourtheme <- theme_light(base_size = 10)+
    theme(axis.text = element_text(color = "black"), legend.position = "top")
theme_set(ourtheme)

# Load your datasets
fish.dat <- readxl::read_excel("../Data_FinalProject/Data/Raw/mrip_estim_catch_wave_1990_2019_NC.xlsx")
blue.dat <- read.csv("../Data_FinalProject/Data/Raw/BLUEFISH_mrip_estim_catch_wave_1990_2019_nc.csv")
bass.dat <- read.csv("../Data_FinalProject/Data/Raw/BSB_mrip_estim_catch_wave_1990_2019_nc.csv")

```

# Rationale and Research Questions

- Are there trends in the amount of these fish caught over time? How do they compare?

- What could these trends look like in the future?

>*Write 1-2 paragraph(s) detailing the rationale for your study. This should include both the context of the topic as well as a rationale for your choice of dataset (reason for location, variables, etc.). You may choose to include citations if you like (optional).*

>*At the end of your rationale, introduce a numbered list of your questions (or an overarching question and sub-questions).* 



\newpage

# Dataset Information
<br />

Data retrieved from NOAA Marine Recreational Information Program download query tool

- Bimonthly recreational fisheries catch totals for NC, 1990-2019

- All species, bluefish (*Pomatomus saltatrix*), and black sea bass (*Centropristis striata*) 

- Multiple areas and modes of fishing  

>*Provide information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the metadata file for the dataset but formatted in a way that is more narrative.*

>*Describe how you wrangled your dataset in a format similar to a methods section of a journal article.*

>*Add a table that summarizes your data structure (variables, units, ranges and/or central tendencies, data source if multiple are used, etc.). This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.*

```{r table1, echo = FALSE}
names <- c("Data Source", "Retrieved from", "Variables Used", "Date Range")
details <-c("NOAA MRIP", "https://www.fisheries.noaa.gov/data-tools/recreational-fisheries-statistics-queries", "Year, Wave, Total Catch, Mode, Area", "January 1990 - December 2019")
dataset_df <- data.frame(names, details)
names(dataset_df) <- c("Detail", "Description")

dataset_table <- kable(dataset_df, caption = "General Information About the Data Used") %>%
    kable_styling(latex_options = "HOLD_position")
dataset_table
```
```{r wave to month, include=FALSE}
wave_to_month_function <-  (function(WAVE) {
  if(WAVE == 1) {
    "Jan"
  }
  else if(WAVE == 2) {
    "Mar"
  }
  else if(WAVE == 3) {
    "May"
  }
  else if(WAVE == 4) {
    "Jul"
  }
  else if(WAVE == 5) {
    "Sep"
  }
  else {
    "Nov"
  }
})
wave_to_month_function_V <- Vectorize(wave_to_month_function) #vectorize function
```

```{r tidy datasets, include=FALSE}
## all
fish.tidy <- fish.dat %>%
  select(YEAR, WAVE, MODE_FX, AREA_X, TOT_CAT) %>%
  mutate(MONTH = wave_to_month_function_V(WAVE)) %>%
  mutate(DATE = my(paste0(MONTH, "-", YEAR))) %>%
  select(DATE, MONTH, YEAR, MODE_FX, AREA_X, TOT_CAT)

fish.tidy.summary <- fish.tidy %>%
  select(DATE, MONTH, YEAR, TOT_CAT) %>%
  group_by(DATE) %>%
  summarise(TOT_CAT_ALL = sum(TOT_CAT)) 

date_list <- as.data.frame(seq.Date(from = as.Date(first(fish.tidy.summary$DATE)), to = as.Date(last(fish.tidy.summary$DATE)), by = "2 months"))
colnames(date_list) <- c("DATE")

fish.summary.interpolate <- left_join(date_list, fish.tidy.summary)
sum(is.na(fish.summary.interpolate$TOT_CAT_ALL))#only 11 NAs! <- OLD DATA. New data has 18 NAs
fish.before.interpolate <- fish.summary.interpolate #create copy before interpolating to quantify NAs
fish.summary.interpolate$TOT_CAT_ALL <- na.approx(fish.summary.interpolate$TOT_CAT_ALL)

write.csv(fish.summary.interpolate, './Data/Processed/fish_summary_interpolate.csv')

##blue
blue.tidy <- blue.dat %>%
  select(YEAR, WAVE, MODE_FX, AREA_X, TOT_CAT) %>%
  mutate(MONTH = wave_to_month_function_V(WAVE)) %>%
  mutate(DATE = my(paste0(MONTH, "-", YEAR))) %>%
  select(DATE, MONTH, YEAR, MODE_FX, AREA_X, TOT_CAT)

blue.tidy.summary <- blue.tidy %>%
  select(DATE, MONTH, YEAR, TOT_CAT) %>%
  group_by(DATE) %>%
  summarise(TOT_CAT_ALL = sum(TOT_CAT)) 

date_list <- as.data.frame(seq.Date(from = as.Date(first(blue.tidy.summary$DATE)), to = as.Date(last(blue.tidy.summary$DATE)), by = "2 months"))
colnames(date_list) <- c("DATE")

blue.summary.interpolate <- left_join(date_list, blue.tidy.summary)
sum(is.na(blue.summary.interpolate$TOT_CAT_ALL))
blue.before.interpolate <- blue.summary.interpolate #create copy before interpolating to quantify NAs
blue.summary.interpolate$TOT_CAT_ALL <- na.approx(blue.summary.interpolate$TOT_CAT_ALL)

write.csv(blue.summary.interpolate, './Data/Processed/blue_summary_interpolate.csv')


## bass
bass.tidy <- bass.dat %>%
  select(YEAR, WAVE, MODE_FX, AREA_X, TOT_CAT) %>%
  mutate(MONTH = wave_to_month_function_V(WAVE)) %>%
  mutate(DATE = my(paste0(MONTH, "-", YEAR))) %>%
  select(DATE, MONTH, YEAR, MODE_FX, AREA_X, TOT_CAT)

bass.tidy.summary <- bass.tidy %>%
  select(DATE, MONTH, YEAR, TOT_CAT) %>%
  group_by(DATE) %>%
  summarise(TOT_CAT_ALL = sum(TOT_CAT)) 

date_list <- as.data.frame(seq.Date(from = as.Date(first(bass.tidy.summary$DATE)), to = as.Date(last(bass.tidy.summary$DATE)), by = "2 months"))
colnames(date_list) <- c("DATE")

bass.summary.interpolate <- left_join(date_list, bass.tidy.summary)
sum(is.na(bass.summary.interpolate$TOT_CAT_ALL))
bass.before.interpolate <- bass.summary.interpolate #create copy before interpolating to quantify NAs
bass.summary.interpolate$TOT_CAT_ALL <- na.approx(bass.summary.interpolate$TOT_CAT_ALL)

write.csv(bass.summary.interpolate, './Data/Processed/bass_summary_interpolate.csv')
```

```{r table2, echo = FALSE}
col1 <- c("Minimum", "Mean", 'Median', "Maximum")

col2 <- c(as.integer(min(fish.summary.interpolate$TOT_CAT_ALL)),
          as.integer(mean(fish.summary.interpolate$TOT_CAT_ALL)), 
          as.integer(median(fish.summary.interpolate$TOT_CAT_ALL)),
          as.integer(max(fish.summary.interpolate$TOT_CAT_ALL)))

col3 <- c(as.integer(min(blue.summary.interpolate$TOT_CAT_ALL)),
          as.integer(mean(blue.summary.interpolate$TOT_CAT_ALL)), 
          as.integer(median(blue.summary.interpolate$TOT_CAT_ALL)),
          as.integer(max(blue.summary.interpolate$TOT_CAT_ALL)))

col4 <- c(as.integer(min(bass.summary.interpolate$TOT_CAT_ALL)),
          as.integer(mean(bass.summary.interpolate$TOT_CAT_ALL)), 
          as.integer(median(bass.summary.interpolate$TOT_CAT_ALL)),
          as.integer(max(bass.summary.interpolate$TOT_CAT_ALL)))

catchsummaries_df <- data.frame(col1, col2, col3, col4)
names(catchsummaries_df) <- c("Summary Statistics", "All Fish", "Bluefish", "Black Sea Bass")

catchsummaries_table <- kable(catchsummaries_df, caption = "Total Catch Summaries") %>%
    kable_styling(latex_options = "HOLD_position")
catchsummaries_table
```
\newpage

# Exploratory Analysis 

We began our analysis by converting waves to months, in order to process the six annual waves using time series analyses. For NOAA fishing records, wave 1 represents January and February, wave 2 represents March and April, and this continues through the year. Therefore, we assigned wave 1 catches to the date of January 1, wave 2 catches to March 1, and beyond. We checked the number of waves without catch records for each dataset by joining the existing data to a list of all possible waves between Wave 1 of 1990 (represented by 1990-01-01) and Wave 6 of 2019 (2019-11-01). The results of this exploration, which informed our approach for interpolation, can be found in Table 3.

```{r table3, echo = FALSE}
datasets <- c("All fish", "Bluefish", "Black sea bass")
numberNAs <-c(sum(is.na(fish.before.interpolate$TOT_CAT_ALL)),
            sum(is.na(blue.before.interpolate$TOT_CAT_ALL)),
            sum(is.na(bass.before.interpolate$TOT_CAT_ALL)))
NA_df <- data.frame(datasets, numberNAs)
names(NA_df) <- c("Dataset", "Number of missing values")

NA_table <- kable(NA_df, caption = "Number of missing values from NOAA MRIP data") %>%
    kable_styling(latex_options = "HOLD_position")
NA_table

```

To fill the gaps with no data, we interpolated the likely values of missing time periods. This interpolation incorporated the catch numbers on either side chronologically. We graphed the total catch trends over time (with the newly interpolated values for missing periods) as shown in Figure 1. With this visualization, we could compare the three categories' recreational fishing catch patterns: all fish, bluefish, and black sea bass. 

```{r ggplot, echo=FALSE, fig.height = 5, fig.width = 6, fig.cap = "Total Catch Patterns over Time"}
fish_ggplot <- ggplot(fish.summary.interpolate, aes(x = DATE, y = TOT_CAT_ALL)) +
  geom_line() +
  geom_smooth(method = "lm")+
  labs(x="Date", y="Total Catch", title = "All Fish")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

blue_ggplot <- ggplot(blue.summary.interpolate, aes(x = DATE, y = TOT_CAT_ALL)) +
  geom_line() +
  geom_smooth(method = "lm")+
  labs(x="Date", y="Total Catch", title = "Bluefish")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bass_ggplot <- ggplot(bass.summary.interpolate, aes(x = DATE, y = TOT_CAT_ALL)) +
  geom_line() +
  geom_smooth(method = "lm")+
  labs(x="Date", y="Total Catch", title = "Black Sea Bass")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_grid(fish_ggplot, blue_ggplot, bass_ggplot, nrow = 3)
```

\newpage

# Analysis



## Question 1: Are there trends in the amount of these fish caught over time? How do they compare?

##Annie, certainly feel free to restructure these figures etc. as fits with the text. I (Ardath) consolidated the p-values into a table to try & help make it visualize more clearly, too! I put the 3 tests into one chunk, but/and we can rearrange & smooth it out together on Sun, too.

>*Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.*

>*Each figure should be accompanied by a caption, and each figure should be referenced within the text*


```{r All Fish Trends, echo=FALSE, fig.height = 3.5, fig.cap = 'Seasonal and Trend Decomposition for All Fish Total Catch'}
fish.fmonth <- month(first(fish.summary.interpolate$DATE))
fish.fyear <- year(first(fish.summary.interpolate$DATE))

fish.summary.interpolate.ts <- ts(fish.summary.interpolate$TOT_CAT_ALL, 
                           start = c(fish.fyear, fish.fmonth),frequency = 6)
fish.summary.ts.decomp <- stl(fish.summary.interpolate.ts, s.window = "periodic")
plot(fish.summary.ts.decomp)

```

```{r Bluefish Trends, echo=FALSE, fig.height = 3.5, fig.cap = 'Seasonal and Trend Decomposition for Bluefish Total Catch'}
blue.fmonth <- month(first(blue.summary.interpolate$DATE))
blue.fyear <- year(first(blue.summary.interpolate$DATE))

blue.summary.interpolate.ts <- ts(blue.summary.interpolate$TOT_CAT_ALL, 
                           start = c(blue.fyear, blue.fmonth),frequency = 6)
blue.summary.ts.decomp <- stl(blue.summary.interpolate.ts, s.window = "periodic")
plot(blue.summary.ts.decomp)

```

```{r Black Sea Bass Trends, echo=FALSE, fig.height = 3.5, fig.cap = 'Seasonal and Trend Decomposition for Black Sea Bass Total Catch'}
bass.fmonth <- month(first(bass.summary.interpolate$DATE))
bass.fyear <- year(first(bass.summary.interpolate$DATE))

bass.summary.interpolate.ts <- ts(bass.summary.interpolate$TOT_CAT_ALL, 
                           start = c(bass.fyear, bass.fmonth),frequency = 6)
bass.summary.ts.decomp <- stl(bass.summary.interpolate.ts, s.window = "periodic")
plot(bass.summary.ts.decomp)

```

```{r Trends, include=FALSE}
fish.trend <- Kendall::SeasonalMannKendall(fish.summary.interpolate.ts)
fish.trend

blue.trend <- Kendall::SeasonalMannKendall(blue.summary.interpolate.ts)
blue.trend

bass.trend <- Kendall::SeasonalMannKendall(bass.summary.interpolate.ts)
bass.trend

```

```{r table4, echo = FALSE}
fishtrends_df <- data.frame(c("All Fish", fish.trend))
names(fishtrends_df) <- c("Fish Category", "tau", "pvalue", "S", "D", "varS")

bluetrends_df <- data.frame(c("Bluefish", blue.trend))
names(bluetrends_df) <- c("Fish Category", "tau", "pvalue", "S", "D", "varS")

basstrends_df <- data.frame(c("Black Sea Bass", bass.trend))
names(basstrends_df) <- c("Fish Category", "tau", "pvalue", "S", "D", "varS")

fishbluetrends_df <- full_join(fishtrends_df, bluetrends_df)
trends_df <- full_join(fishbluetrends_df, basstrends_df)
trends_df <- select(trends_df, c("Fish Category"), tau, pvalue) %>%
  mutate(pvalue = format(pvalue, scientific = TRUE)) %>%
  rename("2-Sided P-value" = pvalue)

trends_table <- kable(trends_df, caption = "Seasonal Mann Kendall Tests") %>%
    kable_styling(latex_options = "HOLD_position")
trends_table
```
For both individual species and all species combined, **reject the null hypothesis** that there is no trend.

## Question 2: What could these trends look like in the future?

```{r, echo=FALSE, fig.height = 5, fig.width = 6}
holtsfish <- HoltWinters(fish.summary.interpolate.ts)
fish.predict.HW <- forecast(holtsfish, h=30, findfrequency = TRUE)
fish.predict.plot <- autoplot(fish.predict.HW,
    xlab= "Date", ylab = "Total Catch", main = "All Fish")

holtsblue <- HoltWinters(blue.summary.interpolate.ts)
blue.predict.HW <- forecast(holtsblue, h=30, findfrequency = TRUE)
blue.predict.plot <- autoplot(blue.predict.HW,
    xlab= "Date", ylab = "Total Catch", main = "Bluefish")

holtsbass <- HoltWinters(bass.summary.interpolate.ts)
bass.predict.HW <- forecast(holtsbass, h=30, findfrequency = TRUE)
bass.predict.plot <- autoplot(bass.predict.HW,
    xlab= "Date", ylab = "Total Catch", main = "Black Sea Bass")

plot_grid(fish.predict.plot, blue.predict.plot, bass.predict.plot, nrow = 3)

#forecasting: note that Holt Winters weighs more recent data more heavily than older data (e.g. bluefish total trend is positive but forecasted trend looks negative) and predicts data without much noise in it, which is unlikely to be the case IRL. Useful visualization but inaccurate bc of complexities in fishing data. (could go above w forecasting slides)

```


\newpage

# Summary and Conclusions

>*Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.*

<br />

## Strong seasonal trends

NOAA marine recreational fishing catch totals for North Carolina show strong seasonal trends. Many more fish are caught in the summer, and much fewer fish are caught in the winter, as demonstrated above (Figure 1). The high seasonality for all three datasets analyzed was confirmed with the Seasonal Mann Kendall Tests, where all three P-values < 0.05 (Table 4). 

This seasonality is likely influenced by recreational fishing patterns, where fishers are more likely to fish in the warm summer weather than the cool winter weather. Another potential cause for the seasonal trends is fish abundance and migration patterns, with higher populations of fish in North Carolina waters during the summer than during the winter. Total catch trends for all fish and Black Sea Bass showed unimodal peaks and valleys overall, while Bluefish showed bimodal trends (Figure 1). These bimodal Bluefish peaks could be due to their seasonal migration patterns ([ASMFC 2021](http://www.asmfc.org/species/bluefish)).

<br />

## Overall positive trend
+ Increase in recreational fishing
+ Variation from changing regulations, behavior

<br />

## Limitations
+ Data collection: Estimates based on surveys of fishers 
+ Interpolation
+ Uncertainty in forecasting

<br />

## Future recommendations
+ Comparisons of other species or other states
+ Catch per unit effort
+ Include earlier data


\newpage

# References
<add references here if relevant, otherwise delete this section> 
